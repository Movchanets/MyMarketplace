name:  Deploy to Azure (Container Apps + Static Front)

on:
  workflow_dispatch:
  push:
    branches:
      - main
  workflow_run:
    workflows: ["CI - Pull Request"]
    types: [completed]
    branches:
      - main

permissions:
  contents: read
  packages: write

env:
  DOTNET_VERSION: '10.0.x'
  NODE_VERSION: '20.x'

jobs:
  # ============================================
  # Build & Deploy to Azure Container Apps (API)
  # ============================================
  deploy-container-apps:
    runs-on: ubuntu-latest
    # Run on: manual trigger, push to main, or successful CI workflow
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      api_url: ${{ steps.get-api-url.outputs.url }}
    env:
      AZURE_STORAGE_CONTAINER_NAME: ${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}
      AZURE_LOCATION: ${{ secrets.AZURE_LOCATION || 'westeurope' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore + Build + Publish API
        run: |
          dotnet restore
          dotnet build --configuration Release --no-restore
          dotnet publish API/API.csproj -c Release -o ./publish

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to GitHub Container Registry
        run: |
          ACTOR_LC=$(echo "${{ github.actor }}" | tr '[:upper:]' '[:lower:]')
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "$ACTOR_LC" --password-stdin

      - name: Ensure Container Apps Environment exists
        run: |
          if ! az containerapp env show --name ${{ secrets.AZURE_CONTAINERAPPS_ENVIRONMENT_NAME }} --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} >/dev/null 2>&1; then
            echo "Creating Container Apps Environment..."
            az containerapp env create \
              --name ${{ secrets.AZURE_CONTAINERAPPS_ENVIRONMENT_NAME }} \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --location $AZURE_LOCATION
          else
            echo "Container Apps Environment already exists."
          fi

      - name: Ensure API Container App exists
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          ACTOR_LC=$(echo "${{ github.actor }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME="ghcr.io/$OWNER_LC/mymarketplace/app-api:latest"
          if ! az containerapp show --name ${{ secrets.AZURE_CONTAINERAPP_API_NAME }} --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} >/dev/null 2>&1; then
            echo "Creating API Container App..."
            az containerapp create \
              --name ${{ secrets.AZURE_CONTAINERAPP_API_NAME }} \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --environment ${{ secrets.AZURE_CONTAINERAPPS_ENVIRONMENT_NAME }} \
              --image "$IMAGE_NAME" \
              --target-port 80 \
              --ingress external \
              --registry-server ghcr.io \
              --registry-username "$ACTOR_LC" \
              --registry-password ${{ secrets.GITHUB_TOKEN }} \
              --min-replicas 0 --max-replicas 1 \
              --env-vars \
                "ASPNETCORE_ENVIRONMENT=Production" \
                "JwtSettings__AccessTokenSecret=${{ secrets.JWT_ACCESS_TOKEN_SECRET }}" \
                "JwtSettings__RefreshTokenSecret=${{ secrets.JWT_REFRESH_TOKEN_SECRET }}" \
                "ConnectionStrings__NeonConnection=${{ secrets.DATABASE_CONNECTION_STRING }}" \
                "Storage__Provider=azure" \
                "Storage__Azure__ConnectionString=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
                "Storage__Azure__ContainerName=$AZURE_STORAGE_CONTAINER_NAME" \
                "Storage__Azure__CdnUrl=${{ secrets.AZURE_CDN_URL }}" \
                "SmtpSettings__Username=${{ secrets.SMTP_USERNAME }}" \
                "SmtpSettings__Password=${{ secrets.SMTP_PASSWORD }}" \
                "Turnstile__Secret=${{ secrets.TURNSTILE_SECRET }}" \
                "AllowedCorsOrigins=${{ secrets.ALLOWED_CORS_ORIGINS }}" \
                "Redis__Enabled=${{ secrets.REDIS_ENABLED }}" \
                "Redis__ConnectionString=${{ secrets.REDIS_CONNECTION_STRING }}" \
                "Redis__InstanceName=${{ secrets.REDIS_INSTANCE_NAME }}"
          else
            echo "API Container App already exists. Will update image & env vars next."
          fi

      - name: Build & Push API Image
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME="ghcr.io/$OWNER_LC/mymarketplace/app-api:latest"
          docker build -t "$IMAGE_NAME" -f API/Dockerfile .
          docker push "$IMAGE_NAME"

      - name: Deploy API to Azure Container Apps
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          az containerapp update \
            --name ${{ secrets.AZURE_CONTAINERAPP_API_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --image ghcr.io/$OWNER_LC/mymarketplace/app-api:latest \
            --set-env-vars \
              "ASPNETCORE_ENVIRONMENT=Production" \
              "JwtSettings__AccessTokenSecret=${{ secrets.JWT_ACCESS_TOKEN_SECRET }}" \
              "JwtSettings__RefreshTokenSecret=${{ secrets.JWT_REFRESH_TOKEN_SECRET }}" \
              "ConnectionStrings__NeonConnection=${{ secrets.DATABASE_CONNECTION_STRING }}" \
              "Storage__Provider=azure" \
              "Storage__Azure__ConnectionString=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
              "Storage__Azure__ContainerName=${{ env.AZURE_STORAGE_CONTAINER_NAME }}" \
              "Storage__Azure__CdnUrl=${{ secrets.AZURE_CDN_URL }}" \
              "SmtpSettings__Username=${{ secrets.SMTP_USERNAME }}" \
              "SmtpSettings__Password=${{ secrets.SMTP_PASSWORD }}" \
              "Turnstile__Secret=${{ secrets.TURNSTILE_SECRET }}" \
              "AllowedCorsOrigins=${{ secrets.ALLOWED_CORS_ORIGINS }}" \
              "Redis__Enabled=${{ secrets.REDIS_ENABLED }}" \
              "Redis__ConnectionString=${{ secrets.REDIS_CONNECTION_STRING }}" \
              "Redis__InstanceName=${{ secrets.REDIS_INSTANCE_NAME }}"

      - name: Get API URL
        id: get-api-url
        run: |
          FQDN=$(az containerapp show \
            --name ${{ secrets.AZURE_CONTAINERAPP_API_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          if [ -z "$FQDN" ]; then
            echo "Failed to resolve API FQDN" >&2
            exit 1
          fi
          API_URL="https://$FQDN/api"
          echo "Resolved API URL: $API_URL"
          echo "url=$API_URL" >> $GITHUB_OUTPUT

  # ============================================
  # Build & Upload Frontend to Azure Storage Static Website
  # ============================================
  deploy-frontend-static:
    runs-on: ubuntu-latest
    needs: deploy-container-apps
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Front/package-lock.json

      - name: Install dependencies
        working-directory: ./Front
        run: |
          echo "Primary install (npm ci)"
          if ! npm ci; then
            echo "npm ci failed, applying rollup optional dependency workaround"
            rm -rf node_modules
            # Preserve lockfile snapshot for debugging
            cp package-lock.json package-lock.backup.json || true
            npm install
          fi

      - name: Build frontend
        working-directory: ./Front
        env:
          VITE_API_URL: ${{secrets.VITE_API_URL }}
          VITE_TURNSTILE_SITEKEY: ${{ secrets.VITE_TURNSTILE_SITEKEY }}
        run: |
          echo "Node version:" $(node -v)
          echo "VITE_API_URL=${VITE_API_URL}"
          if [ -z "${VITE_API_URL}" ]; then
            echo "VITE_API_URL is empty. Failing build to avoid publishing wrong base URL." >&2
            exit 1
          fi
          npm run build

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Upload to Azure Storage Static Website ($web)
        run: |
          az storage blob service-properties update \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
            --static-website \
            --index-document index.html \
            --404-document index.html

          az storage blob upload-batch \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
            --destination '$web' \
            --source ./Front/dist \
            --overwrite
  # Manual-only workflow with two jobs (API + static front)
